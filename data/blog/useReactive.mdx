---
title: useReactiveã€‚
date: '2021-11-17'
tags: ['react', 'hooks']
draft: false
summary: 'react hooks'
---

å‰ç½®ç›¸å…³çŸ¥è¯†ï¼š
[weakMap](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WeakMap 'weakMap')
[Proxy](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy 'Proxy')

```js:WeakMapé£Ÿç”¨ğŸŒ°
// WeakMap çš„é”®åªèƒ½æ˜¯å¯¹è±¡
const wm = new WeakMap();
let key = {} // å †å†…å­˜ç”Ÿæˆä¸€ä¸ªå¯¹è±¡ æš‚æ—¶å« obj1
wm.set(key, 1);
key = null;

```

å½“æˆ‘ä»¬è®¾ç½® `wm.set(key, 1)` æ—¶ï¼Œ wm å¯¹ key æ‰€å¼•ç”¨çš„å¯¹è±¡çš„æ˜¯å¼±å¼•ç”¨

ç„¶åæŠŠ `key è®¾ç½®ä¸º nullï¼Œobj1 å°±åªæœ‰ wm çš„å¼±å¼•ç”¨å…³ç³»`ï¼Œåƒåœ¾å›æ”¶å†æ¬¡æ£€æŸ¥åˆ°ä¼šæ‰§è¡Œå›æ”¶æœºåˆ¶ã€‚

å¼±å¼•ç”¨ï¼š

> åƒåœ¾å›æ”¶æœºåˆ¶ä¸è€ƒè™‘å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå…¶ä»–å¯¹è±¡éƒ½ä¸å†å¼•ç”¨è¯¥å¯¹è±¡ï¼Œé‚£ä¹ˆåƒåœ¾å›æ”¶æœºåˆ¶ä¼šè‡ªåŠ¨å›æ”¶è¯¥å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ï¼Œä¸è€ƒè™‘è¯¥å¯¹è±¡æ˜¯å¦è¿˜åœ¨è¯¥å¼±å¼•ç”¨çš„ç»“æ„ä¸­ã€‚
æ³¨æ„ï¼š å¼±å¼•ç”¨çš„å¯¹è±¡ä¸å¯éå†ï¼

```js:hookså“åº”å¼å®ç°
import { useRef } from 'react'
import { useCreation } from '../useCreation'
import { useUpdate } from '../useUpdate'
// k:v åŸå¯¹è±¡:ä»£ç†è¿‡çš„å¯¹è±¡   å­˜å‚¨ä»£ç†è¿‡çš„å¯¹è±¡
const proxyMap = new WeakMap()
// k:v ä»£ç†è¿‡çš„å¯¹è±¡:åŸå¯¹è±¡   å­˜å‚¨åŸå¯¹è±¡
const rawMap = new WeakMap()

function isObject(val) {
  return typeof val === 'object' && val !== null
}
// ä¸ºç›®æ ‡å¯¹è±¡æ·»åŠ ä»£ç†
function observer(initialVal, cb) {
  const existingProxy = proxyMap.get(initialVal)

  // æ·»åŠ ç¼“å­˜ é˜²æ­¢é‡æ–°æ„å»ºproxy
  if (existingProxy) {
    return existingProxy
  }

  // é˜²æ­¢ä»£ç†å·²ç»ä»£ç†è¿‡çš„å¯¹è±¡
  if (rawMap.has(initialVal)) {
    return initialVal
  }
  // å¼€å§‹åªè®¾ç½®å½“å‰ä¼ å…¥å¯¹è±¡ä¸ºä»£ç†å¯¹è±¡
  const proxy = new Proxy(initialVal, {
    get(target, key, receiver) {
      // è·å–å€¼æ—¶ æŠŠè®¿é—®è·¯å¾„çš„æ‰€æœ‰å¯¹è±¡éƒ½ä»£ç†ä¸ºproxyå¯¹è±¡   ï¼ï¼è¿™ä¸ªä½ç½®æ€æƒ³æ¯”è¾ƒå…³é”®
      const res = Reflect.get(target, key, receiver)
      return isObject(res) ? observer(res, cb) : Reflect.get(target, key)
    },
    set(target, key, val) {
      const ret = Reflect.set(target, key, val)
      cb()
      return ret
    },
    deleteProperty(target, key) {
      const ret = Reflect.deleteProperty(target, key)
      cb()
      return ret
    },
  })
  // æŠŠä»£ç†å¯¹è±¡å’ŒåŸå¯¹è±¡ ç¼“å­˜èµ·æ¥ é˜²æ­¢é‡å¤åˆ›å»º
  proxyMap.set(initialVal, proxy)
  rawMap.set(proxy, initialVal)

  return proxy
}
// æ¥æ”¶è¢«ä»£ç†çš„ç›®æ ‡å¯¹è±¡
export function useReactive(initialState) {
  // è§¦å‘æ¸²æŸ“æ›´æ–°
  const update = useUpdate()
  // è·å–åˆå§‹éœ€è¦ä»£ç†çš„æ•°æ®
  const stateRef = useRef(initialState)
  // ç¼“å­˜ä»£ç†å¯¹è±¡
  const state = useCreation(() => {
    return observer(stateRef.current, () => {
      update()
    })
  }, [])

  return state
}

```
