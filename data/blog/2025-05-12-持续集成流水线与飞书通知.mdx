---
title: '部署不是黑盒：一条可观测的自动化流水线与飞书告警'
date: '2025-05-12'
tags: ['CI/CD', 'Feishu', '自动化运维']
draft: false
summary: '详解如何把服务平台的打包、部署、验证与通知串起来，让每次上线都能自动同步给相关同学。'
---

服务平台迭代频繁，过去的部署流程依赖手工触发 + 人肉同步，导致出问题时很难追根溯源。春节后我重构了整条流水线：Git 推送触发 Turbo 构建、容器部署、E2E 验证，最后把结果推送到飞书群里，涵盖状态、版本号以及关键指标。

### 工作流设计

- **构建阶段**：借助 Turborepo 的缓存能力，只构建发生变化的 package，平均构建时间从 12 分钟降到 4 分钟。
- **部署阶段**：使用 `kustomize` 渲染环境差异，流水线里直接调用 `kubectl apply`。部署完成后执行 `smoke.sh` 校验健康检查与核心接口。
- **通知阶段**：飞书机器人接入在流水线最后一步，通过签名校验确保消息来源可信。消息模板包含 Commit 链接、容器 Tag、Smoke 结果与影像链接。

```yaml
notify:
  image: alpine/curl
  script:
    - 'curl -X POST $FEISHU_WEBHOOK -H "Content-Type: application/json" -d "$PAYLOAD"'
```

飞书群收到通知后，如果 Smoke 失败，会自动 @ 当前责任人，方便第一时间回滚。上线窗口则以周为单位，保障博客呈现“周期更新”的节奏。
