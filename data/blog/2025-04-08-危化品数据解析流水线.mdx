---
title: '批量提取化学品 MSDS 到 JSON'
date: '2025-04-08'
tags: ['Python', '数据治理', 'docx']
draft: false
summary: '使用 Apache Tika 批量解析 SDS/MSDS 文档，并将结果结构化为 JSON。'
---

# bat.chemicals.py 解析流水线

> 目标：把「增补卷-危险化学品安全技术全书-996条」文件夹下的 MSDS / SDS 文档统一解析、清洗，并生成可直接入库的 JSON，同时保留日志和原始文本快照。

## 总体流程

1. **加载依赖与配置**  
   - `tika.parser` 负责解码多格式文档。  
   - 自定义日志系统同时写入 `processing_log_tika_final.log` 与终端，便于实时追踪。
2. **读取源文件**  
   - 遍历输入目录，跳过临时文件（文件名前缀 `~`）。  
   - 每个文件调用 `read_text_with_tika`，统一获取纯文本；失败则记录并继续下一个文件。
3. **文本预处理**  
   - `process_and_htmlize_text` 清理空白字符/不可见字符，压缩多余空格，并按 `<br>` 拼接为轻量 HTML，保证数据在前端即可直接渲染。  
   - `process_to_flat_string` 用空格替换换行，适用于需要单行的字段（如分子式、UN 编号等）。  
   - `get_value` 安全文本提取：正则缺失时自动回退默认值，避免抛异常。
4. **章节解析 → JSON**  
   - 通过 `s_headers` 的 16 个章节正则定位每个 SDS 部分，再逐段解析。  
   - 生成结构化数据 `chemical_product` ~ `chemical_other_info`，并补全 `id / created_at / updated_at / CreatedBy / UpdatedBy` 等元信息。  
   - 解析完成的对象 append 进 `all_chemicals_data`。
5. **结果落盘**  
   - `chemicals_database_tika_final.json`：所有化学品条目组成的数组，`ensure_ascii=False` 保留中文。  
   - `combined_source_text_tika.txt`：所有原始文本拼接（包含分隔 header）。  
   - `processing_log_tika_final.log`：批量处理日志与错误信息。

## 核心解析设计

### 章节定位

```python filename="batchword/bat.chemicals.py"
s_headers = {
    "s1": r"第\s*一\s*部\s*分\s*化\s*学\s*品\s*标\s*识",
    "s2": r"第\s*二\s*部\s*分\s*危\s*险\s*性\s*概\s*述",
    # ...
    "s16": r"第\s*十\s*六\s*部\s*分\s*其\s*他\s*信\s*息",
}
section1_block = get_value(
    f"({s_headers['s1']}.*?)(?={s_headers['s2']}|$)", text_entry, group_num=1
)
```

通过 `get_value` + 章节正则组合，采用“从当前章节开始，直到下一章节标题”为边界的滑动窗口策略，确保在格式存在噪声时依旧可容错。

### 精细字段映射

- **化学品标识**：自动拆分中文/英文别名、分子式、相对分子质量，并推断物态（固体/液体/气体）。  
- **危险性概述**：针对象形图 `GHSxx` 解析、GHS 分类、危险/预防/响应等文本分别清洗。  
- **成分信息**：利用最后一行的 `CAS` 号匹配，自动分离化学名称与 `CAS Code`。  
- **理化特性**：`props_definitions` 定义字段 → 正则批量切片，保持扩展性。  
- **法规信息**：汇总国内法规与斯德哥尔摩 / 鹿特丹 / 蒙特利尔公约，并把公约信息组合成 HTML 片段，方便前端直接展示。

### 鲁棒性策略

- **空值兜底**：所有提取函数在缺失字段时返回空字符串，后续 JSON 仍能稳定序列化。  
- **时间戳统一**：使用 JST（UTC+9）时间生成 `created_at / updated_at`，可追踪批处理批次。  
- **日志级别**：`INFO` 记录进度，`WARNING` 提示空文件或 Tika 失败，`ERROR/CRITICAL` 记录解析异常与写盘问题。

## 运行方式

1. 安装依赖（确保 Java 环境和 `tika` 已配置）。  
2. 将全部 MSDS 文件放入 `增补卷-危险化学品安全技术全书-996条` 目录。  
3. 执行：

```bash
python batchword/bat.chemicals.py
```

4. 完成后检查：
   - `chemicals_database_tika_final.json`：结构化数据。  
   - `processing_log_tika_final.log`：查看成功/失败文件。  
   - `combined_source_text_tika.txt`：用于溯源原文。

## 辅助工具：123.py

`merge_files_final(folder, output)` 提供文件合并功能：遍历指定目录，按文件名排序依次写入单个文本（读取编码 `gbk`，输出 `utf-8`），并在每个文件前后写入 `START/END` 标记，便于在 Tika 运行前先预览或手工校验原始资料。

```python filename="batchword/123.py"
with open(current_file_path, "r", encoding="gbk") as infile:
    outfile.write(f"\n\n{'='*20} START: {filename} {'='*20}\n\n")
    outfile.write(infile.read())
    outfile.write(f"\n\n{'='*20} END: {filename} {'='*20}\n\n")
```

## 可扩展方向

- 将 `props_definitions`、`toxic_map` 等映射配置化，方便日后增减字段。  
- 在主循环中加入失败重试、进度条或并行处理以提升吞吐。  
- 针对解析结果补充单元测试（可对特定 MSDS 文本构造快照），保证正则规则变动时不破坏数据结构。  
- 输出 JSON 的同时生成 CSV / API Mock，方便数据同步到前端或第三方系统。
